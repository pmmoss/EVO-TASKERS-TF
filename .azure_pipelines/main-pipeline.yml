trigger:
  branches:
    include:
      - main

parameters:
  - name: environment
    type: string
    default: 'dev'
  - name: projectName
    type: string
    default: 'evo-taskers'
  - name: appName
    type: string
    default: 'unlockbookings'

variables:
  - group: 'terraform-backend'

stages:
  - stage: Deploy
    displayName: 'Deploy to ${{ parameters.environment }}'
    jobs:
      - job: Terraform
        displayName: 'Terraform Deployment'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
              addToPath: true

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform latest'
            inputs:
              terraformVersion: 'latest'

          - template: templates/terraform-init.yml
            parameters:
              environment: ${{ parameters.environment }}
              workingDirectory: 'project/${{ parameters.projectName }}/common'

          - template: templates/terraform-plan.yml
            parameters:
              environment: ${{ parameters.environment }}
              workingDirectory: 'project/${{ parameters.projectName }}/common'

          - template: templates/terraform-apply.yml
            parameters:
              environment: ${{ parameters.environment }}
              workingDirectory: 'project/${{ parameters.projectName }}/common'
  - stage: DeployApp
    displayName: 'Deploy App Resources'
    jobs:
      - job: DeployApp
        displayName: 'Deploy App Resources'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - template: templates/terraform-init.yml
            parameters:
              environment: ${{ parameters.environment }}
              workingDirectory: 'project/${{ parameters.projectName }}/${{ parameters.appName }}'

          - template: templates/terraform-plan.yml
            parameters:
              environment: ${{ parameters.environment }}
              workingDirectory: 'project/${{ parameters.projectName }}/${{ parameters.appName }}'

          - template: templates/terraform-apply.yml
            parameters:
              environment: ${{ parameters.environment }}
              workingDirectory: 'project/${{ parameters.projectName }}/${{ parameters.appName }}'