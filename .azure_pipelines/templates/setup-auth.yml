# Template: Setup Azure Authentication
# Configures authentication for Terraform using OIDC or Service Principal

parameters:
  - name: serviceConnection
    type: string

steps:
  - task: AzureCLI@2
    displayName: 'Setup Authentication'
    name: auth
    inputs:
      azureSubscription: '${{ parameters.serviceConnection }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      addSpnToEnvironment: true
      inlineScript: |
        echo "=== DEBUG: Authentication Variables ==="
        echo "servicePrincipalId: ${servicePrincipalId:-(empty)}"
        echo "tenantId: ${tenantId:-(empty)}"
        echo "idToken present: $([ -n "$idToken" ] && echo 'YES' || echo 'NO')"
        echo "idToken length: ${#idToken}"
        echo "servicePrincipalKey present: $([ -n "$servicePrincipalKey" ] && echo 'YES' || echo 'NO')"
        echo "servicePrincipalKey length: ${#servicePrincipalKey}"
        echo "======================================"
        
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        echo "Subscription ID: $SUBSCRIPTION_ID"
        
        echo "##vso[task.setvariable variable=ARM_CLIENT_ID;isOutput=true]$servicePrincipalId"
        echo "##vso[task.setvariable variable=ARM_TENANT_ID;isOutput=true]$tenantId"
        echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID;isOutput=true]$SUBSCRIPTION_ID"
        
        if [ -n "$idToken" ]; then
          echo "✓ Using OIDC authentication"
          echo "##vso[task.setvariable variable=ARM_USE_OIDC;isOutput=true]true"
          echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN;isOutput=true]$idToken"
          echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET;isOutput=true]"
        else
          echo "✗ Using Service Principal authentication (OIDC token not available)"
          echo "##[warning]OIDC is not configured - falling back to client secret"
          echo "##vso[task.setvariable variable=ARM_USE_OIDC;isOutput=true]false"
          echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN;isOutput=true]"
          echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET;isOutput=true]$servicePrincipalKey"
        fi

